

<!DOCTYPE html>

<html lang="en">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>anonymous-chat</title>

    <style>

        * {

            margin: 0;

            padding: 0;

            box-sizing: border-box;

        }

        body {

            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;

            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);

            min-height: 100vh;

            padding: 20px;

            color: #fff;

        }

        .container {

            max-width: 900px;

            margin: 0 auto;

        }

        .header {

            text-align: center;

            margin-bottom: 30px;

        }

        .header h1 {

            font-size: 2.5em;

            margin-bottom: 10px;

            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);

        }

        .status-panel {

            background: rgba(255,255,255,0.1);

            backdrop-filter: blur(10px);

            border-radius: 15px;

            padding: 20px;

            margin-bottom: 20px;

            border: 1px solid rgba(255,255,255,0.2);

        }

        .status-row {

            display: flex;

            justify-content: space-between;

            margin-bottom: 10px;

            padding: 8px;

            background: rgba(0,0,0,0.2);

            border-radius: 8px;

        }

        .status-label {

            font-weight: bold;

            color: #a8d5ff;

        }

        .status-value {

            font-family: monospace;

            font-size: 0.9em;

        }

        .key-section {

            background: rgba(255,255,255,0.15);

            padding: 15px;

            border-radius: 10px;

            margin-bottom: 15px;

        }

        .key-title {

            font-weight: bold;

            color: #ffc107;

            margin-bottom: 8px;

        }

        .key-value {

            font-family: monospace;

            font-size: 0.85em;

            background: rgba(0,0,0,0.3);

            padding: 8px;

            border-radius: 5px;

            word-break: break-all;

        }

        .message-panel {

            background: rgba(255,255,255,0.95);

            color: #333;

            border-radius: 15px;

            padding: 25px;

            margin-bottom: 20px;

            box-shadow: 0 8px 32px rgba(0,0,0,0.3);

        }

        .form-group {

            margin-bottom: 20px;

        }

        .form-group label {

            display: block;

            font-weight: bold;

            margin-bottom: 8px;

            color: #2a5298;

        }

        .form-group input, .form-group textarea {

            width: 100%;

            padding: 12px;

            border: 2px solid #ddd;

            border-radius: 8px;

            font-size: 1em;

            transition: border-color 0.3s;

            font-family: monospace;

        }

        .form-group input:focus, .form-group textarea:focus {

            outline: none;

            border-color: #2a5298;

        }

        .form-group textarea {

            resize: vertical;

            min-height: 120px;

            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;

        }

        .btn {

            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);

            color: white;

            border: none;

            padding: 12px 20px;

            border-radius: 8px;

            font-size: 1em;

            font-weight: bold;

            cursor: pointer;

            transition: transform 0.2s, box-shadow 0.2s;

        }

        .btn-primary {

            width: 100%;

            padding: 15px 30px;

            font-size: 1.1em;

        }

        .btn-decrypt {

            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);

            margin-top: 10px;

            width: 100%;

        }

        .btn:hover {

            transform: translateY(-2px);

            box-shadow: 0 5px 15px rgba(0,0,0,0.3);

        }

        .btn:active {

            transform: translateY(0);

        }

        .btn:disabled {

            opacity: 0.5;

            cursor: not-allowed;

        }

        .messages-list {

            background: rgba(255,255,255,0.95);

            color: #333;

            border-radius: 15px;

            padding: 25px;

            max-height: 500px;

            overflow-y: auto;

        }

        .message-item {

            background: #f8f9fa;

            border-left: 4px solid #2a5298;

            padding: 15px;

            margin-bottom: 15px;

            border-radius: 8px;

            box-shadow: 0 2px 5px rgba(0,0,0,0.1);

        }

        .message-content {

            font-size: 1.1em;

            margin-bottom: 10px;

            word-wrap: break-word;

            font-family: monospace;

            background: #e9ecef;

            padding: 10px;

            border-radius: 4px;

            max-height: 150px;

            overflow-y: auto;

        }

        .message-content.decrypted {

            background: #d4edda;

            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;

            font-size: 1.15em;

        }

        .message-meta {

            font-size: 0.85em;

            color: #666;

            border-top: 1px solid #ddd;

            padding-top: 10px;

            margin-top: 10px;

        }

        .message-meta div {

            margin-bottom: 5px;

        }

        .key-display {

            font-family: monospace;

            background: #e9ecef;

            padding: 5px 8px;

            border-radius: 4px;

            word-break: break-all;

            font-size: 0.8em;

        }

        .alert {

            padding: 15px;

            border-radius: 8px;

            margin-bottom: 20px;

            font-weight: bold;

        }

        .alert-success {

            background: rgba(40, 167, 69, 0.2);

            border: 2px solid #28a745;

            color: #fff;

        }

        .alert-error {

            background: rgba(220, 53, 69, 0.2);

            border: 2px solid #dc3545;

            color: #fff;

        }

        .alert-warning {

            background: rgba(255, 193, 7, 0.2);

            border: 2px solid #ffc107;

            color: #fff;

        }

        .spinner {

            display: inline-block;

            width: 20px;

            height: 20px;

            border: 3px solid rgba(255,255,255,.3);

            border-radius: 50%;

            border-top-color: #fff;

            animation: spin 1s ease-in-out infinite;

        }

        @keyframes spin {

            to { transform: rotate(360deg); }

        }

        .anonymous-badge {

            display: inline-block;

            background: #dc3545;

            color: white;

            padding: 4px 10px;

            border-radius: 4px;

            font-size: 0.85em;

            font-weight: bold;

            margin-bottom: 8px;

        }

        .decrypt-form {

            display: none;

            background: #fff3cd;

            border: 2px solid #ffc107;

            padding: 15px;

            margin-top: 10px;

            border-radius: 8px;

        }

        .decrypt-form.show {

            display: block;

        }

    </style>

</head>

<body>

    <div class="container">

        <div class="header">

            <h1>anonymous-chat</h1>

            <p>Encrypted Quantum-Safe P2P Communication</p>

        </div>



        <div id="alerts"></div>



        <div class="status-panel">

            <h2 style="margin-bottom: 15px;">System Status</h2>

            <div class="status-row">

                <span class="status-label">Site:</span>

                <span class="status-value">anonymous-chat</span>

            </div>

            <div class="status-row">

                <span class="status-label">Status:</span>

                <span class="status-value" id="siteStatus">Checking...</span>

            </div>

            <div class="status-row">

                <span class="status-label">API:</span>

                <span class="status-value" id="apiStatus">Testing...</span>

            </div>

            

            <div class="key-section">

                <div class="key-title">Site Keys (Same on all machines):</div>

                <div style="margin-top: 10px;">

                    <strong style="color: #ffc107;">Dilithium Private:</strong>

                    <div class="key-value" id="siteDilithiumPrivate">Generating...</div>

                </div>

                <div style="margin-top: 10px;">

                    <strong style="color: #a8d5ff;">Dilithium Public:</strong>

                    <div class="key-value" id="siteDilithiumPublic">Generating...</div>

                </div>

                <div style="margin-top: 10px;">

                    <strong style="color: #ffc107;">Falcon Private:</strong>

                    <div class="key-value" id="siteFalconPrivate">Generating...</div>

                </div>

                <div style="margin-top: 10px;">

                    <strong style="color: #a8d5ff;">Falcon Public:</strong>

                    <div class="key-value" id="siteFalconPublic">Generating...</div>

                </div>

            </div>

            

            <div class="key-section">

                <div class="key-title">Your Individual Key:</div>

                <div class="key-value" id="individualKeyDisplay">Not generated yet</div>

                <div style="margin-top: 8px; font-size: 0.9em; color: #ffc107;">

                    Individual Private Key: <span id="privateKeyDisplay" style="color: #dc3545;">Not generated</span>

                </div>

            </div>

        </div>



        <div class="message-panel">

            <h2 style="margin-bottom: 20px; color: #2a5298;">Post Encrypted Message</h2>

            

            <div class="form-group">

                <label>Step 1: Generate Your Individual Keys</label>

                <button class="btn btn-primary" id="generateKeysBtn" onclick="generateIndividualKeys()">

                    Generate Individual Key Pair

                </button>

            </div>



            <form id="messageForm">

                <div class="form-group">

                    <label for="messageContent">Step 2: Write Your Message</label>

                    <textarea id="messageContent" placeholder="Type your message (will be encrypted before sending)..." required></textarea>

                </div>

                <button type="submit" class="btn btn-primary" id="sendBtn" disabled>

                    Encrypt & Broadcast to Network

                </button>

            </form>

        </div>



        <div class="messages-list">

            <h2 style="margin-bottom: 20px; color: #2a5298;">Network Messages</h2>

            <div id="messagesList">

                <p style="text-align: center; color: #666;">Loading encrypted messages...</p>

            </div>

        </div>

    </div>



    <script>

        const API_BASE = 'http://127.0.0.1:5001';

        const SITE_NAME = 'anonymous-chat';

        const STORAGE_KEY = 'p2p_individual_keys';

        

        // HARDCODED SITE KEYS - SAME ON ALL MACHINES

        const FIXED_SITE_KEYS = {

            dilithium_private: 'a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6',

            dilithium_public: 'f1e2d3c4b5a6f7e8d9c0b1a2f3e4d5c6b7a8f9e0d1c2b3a4f5e6d7c8b9a0f1e2',

            falcon_private: '1a2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2',

            falcon_public: '9f8e7d6c5b4a3f2e1d0c9b8a7f6e5d4c'

        };

        

        let individualPrivateKey = null;

        let individualPublicKeyHex = null;

        let siteKeys = FIXED_SITE_KEYS;



        function initializeSiteKeys() {

            document.getElementById('siteDilithiumPrivate').textContent = siteKeys.dilithium_private;

            document.getElementById('siteDilithiumPublic').textContent = siteKeys.dilithium_public;

            document.getElementById('siteFalconPrivate').textContent = siteKeys.falcon_private;

            document.getElementById('siteFalconPublic').textContent = siteKeys.falcon_public;

            

            console.log('[SITE-KEYS] Fixed hardcoded keys loaded - same on all machines');

        }



        function encryptMessage(message, key) {

            const encoder = new TextEncoder();

            const msgBytes = encoder.encode(message);

            const keyBytes = encoder.encode(key);

            

            let encrypted = [];

            for (let i = 0; i < msgBytes.length; i++) {

                encrypted.push(msgBytes[i] ^ keyBytes[i % keyBytes.length]);

            }

            

            return Array.from(encrypted).map(b => b.toString(16).padStart(2, '0')).join('');

        }



        function decryptMessage(encryptedHex, key) {

            const encoder = new TextEncoder();

            const keyBytes = encoder.encode(key);

            

            let bytes = [];

            for (let i = 0; i < encryptedHex.length; i += 2) {

                bytes.push(parseInt(encryptedHex.substr(i, 2), 16));

            }

            

            let decrypted = [];

            for (let i = 0; i < bytes.length; i++) {

                decrypted.push(bytes[i] ^ keyBytes[i % keyBytes.length]);

            }

            

            const decoder = new TextDecoder();

            return decoder.decode(new Uint8Array(decrypted));

        }



        function saveKeys() {

            if (individualPrivateKey && individualPublicKeyHex) {

                const data = {

                    private: individualPrivateKey,

                    public: individualPublicKeyHex,

                    timestamp: Date.now()

                };

                try {

                    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));

                } catch (e) {

                    console.log('localStorage not available');

                }

            }

        }



        function loadKeys() {

            try {

                const stored = localStorage.getItem(STORAGE_KEY);

                if (stored) {

                    const data = JSON.parse(stored);

                    individualPrivateKey = data.private;

                    individualPublicKeyHex = data.public;

                    

                    updateKeyDisplays();

                    document.getElementById('sendBtn').disabled = false;

                    document.getElementById('generateKeysBtn').textContent = 'Keys Loaded - Ready to Send';

                    document.getElementById('generateKeysBtn').disabled = true;

                    document.getElementById('generateKeysBtn').style.background = '#28a745';

                    

                    showAlert('Individual keys restored from storage', 'success');

                    return true;

                }

            } catch (e) {

                console.log('Could not load keys');

            }

            return false;

        }



        function updateKeyDisplays() {

            const privateDisplay = document.getElementById('privateKeyDisplay');

            const individualDisplay = document.getElementById('individualKeyDisplay');

            

            if (privateDisplay && individualPrivateKey) {

                privateDisplay.textContent = individualPrivateKey;

                privateDisplay.style.color = '#28a745';

            }

            

            if (individualDisplay && individualPublicKeyHex) {

                individualDisplay.textContent = individualPublicKeyHex;

            }

        }



        function generateIndividualKeys() {

            try {

                const randomBytes = new Uint8Array(32);

                window.crypto.getRandomValues(randomBytes);

                

                individualPrivateKey = Array.from(randomBytes)

                    .map(b => b.toString(16).padStart(2, '0'))

                    .join('');

                

                const publicBytes = new Uint8Array(32);

                window.crypto.getRandomValues(publicBytes);

                individualPublicKeyHex = Array.from(publicBytes)

                    .map(b => b.toString(16).padStart(2, '0'))

                    .join('');

                

                updateKeyDisplays();

                saveKeys();

                

                const sendBtn = document.getElementById('sendBtn');

                const generateBtn = document.getElementById('generateKeysBtn');

                

                if (sendBtn) {

                    sendBtn.disabled = false;

                }

                

                if (generateBtn) {

                    generateBtn.textContent = 'Keys Generated - Ready to Send';

                    generateBtn.disabled = true;

                    generateBtn.style.background = '#28a745';

                }

                

                showAlert('Key pair generated and saved', 'success');

            } catch (error) {

                showAlert('Key generation failed: ' + error.message, 'error');

            }

        }



        async function ensureSiteExists() {

            try {

                const response = await fetch(`${API_BASE}/api/sites`);

                const sites = await response.json();

                

                const siteExists = sites.some(s => s.site_name === SITE_NAME);

                

                if (siteExists) {

                    document.getElementById('siteStatus').textContent = 'Active';

                    return true;

                }

                

                // Create site with deterministic keys

                const createResponse = await fetch(`${API_BASE}/api/create_site`, {

                    method: 'POST',

                    headers: { 'Content-Type': 'application/json' },

                    body: JSON.stringify({

                        site_name: SITE_NAME,

                        falcon_private: siteKeys.falcon_private,

                        falcon_public: siteKeys.falcon_public,

                        dilithium_private: siteKeys.dilithium_private,

                        dilithium_public: siteKeys.dilithium_public

                    })

                });

                

                if (createResponse.ok) {

                    document.getElementById('siteStatus').textContent = 'Created';

                    showAlert('Site initialized with deterministic keys', 'success');

                    return true;

                } else {

                    document.getElementById('siteStatus').textContent = 'Error';

                    return false;

                }

            } catch (error) {

                document.getElementById('siteStatus').textContent = 'Error';

                showAlert('Connection failed: ' + error.message, 'error');

                return false;

            }

        }



        async function sendEncryptedMessage(message) {

            const sendBtn = document.getElementById('sendBtn');

            sendBtn.disabled = true;

            sendBtn.innerHTML = '<span class="spinner"></span> Encrypting...';

            

            try {

                const encrypted1 = encryptMessage(message, individualPrivateKey);

                const finalEncrypted = encryptMessage(encrypted1, siteKeys.dilithium_private);

                

                sendBtn.innerHTML = '<span class="spinner"></span> Broadcasting...';

                

                const today = new Date();

                const dateStr = `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth() + 1).padStart(2, '0')}/${today.getFullYear()}`;

                

                const response = await fetch(`${API_BASE}/api/broadcast_content`, {

                    method: 'POST',

                    headers: { 'Content-Type': 'application/json' },

                    body: JSON.stringify({

                        site_name: SITE_NAME,

                        content: JSON.stringify({

                            encrypted: finalEncrypted,

                            public_key: individualPublicKeyHex,

                            date: dateStr

                        })

                    })

                });

                

                if (response.ok) {

                    const result = await response.json();

                    showAlert('Message broadcast to ' + result.peers_notified + ' peers', 'success');

                    document.getElementById('messageContent').value = '';

                    loadMessages();

                } else {

                    throw new Error('Broadcast failed');

                }

            } catch (error) {

                showAlert('Send failed: ' + error.message, 'error');

            } finally {

                sendBtn.disabled = false;

                sendBtn.textContent = 'Encrypt & Broadcast to Network';

            }

        }



        function showDecryptForm(messageId) {

            const form = document.getElementById('decrypt-form-' + messageId);

            if (form) {

                form.classList.toggle('show');

            }

        }



        function decryptMessageWithKey(messageId, encryptedData) {

            const userKey = document.getElementById('user-key-' + messageId).value.trim();

            

            if (!userKey) {

                showAlert('Please enter the individual private key', 'error');

                return;

            }

            

            try {

                // Step 1: Decrypt with site private key (deterministic)

                const decrypted1 = decryptMessage(encryptedData, siteKeys.dilithium_private);

                

                // Step 2: Decrypt with user-provided individual key

                const finalMessage = decryptMessage(decrypted1, userKey);

                

                const contentDiv = document.getElementById('content-' + messageId);

                contentDiv.textContent = finalMessage;

                contentDiv.classList.add('decrypted');

                

                const decryptBtn = document.getElementById('decrypt-btn-' + messageId);

                decryptBtn.textContent = 'Decrypted';

                decryptBtn.disabled = true;

                

                const form = document.getElementById('decrypt-form-' + messageId);

                form.style.display = 'none';

                

                showAlert('Message decrypted successfully', 'success');

            } catch (error) {

                showAlert('Decryption failed - wrong individual key', 'error');

            }

        }



        async function loadMessages() {

            try {

                const response = await fetch(`${API_BASE}/api/content?site=${SITE_NAME}`);

                const messages = await response.json();

                

                const container = document.getElementById('messagesList');

                

                if (!messages || messages.length === 0) {

                    container.innerHTML = '<p style="text-align: center; color: #666;">No messages yet</p>';

                    return;

                }

                

                container.innerHTML = messages.reverse().map((msg, index) => {

                    try {

                        const parsed = JSON.parse(msg.content);

                        const msgId = 'msg-' + index;

                        

                        return `

                            <div class="message-item">

                                <div class="anonymous-badge">ANONYMOUS</div>

                                <div class="message-content" id="content-${msgId}">${parsed.encrypted}</div>

                                <button class="btn btn-decrypt" id="decrypt-btn-${msgId}" onclick="showDecryptForm('${msgId}')">

                                    Decrypt Message

                                </button>

                                <div class="decrypt-form" id="decrypt-form-${msgId}">

                                    <div class="form-group">

                                        <label>Enter Individual Private Key:</label>

                                        <input type="text" id="user-key-${msgId}" placeholder="Paste the sender's individual private key here">

                                        <small style="display: block; margin-top: 5px; color: #666;">

                                            Site key is used automatically (same on all machines)

                                        </small>

                                    </div>

                                    <button class="btn" onclick="decryptMessageWithKey('${msgId}', '${parsed.encrypted}')">

                                        Decrypt Now

                                    </button>

                                </div>

                                <div class="message-meta">

                                    <div><strong>Site:</strong> ${SITE_NAME}</div>

                                    <div><strong>Date:</strong> ${parsed.date || 'Unknown'}</div>

                                    <div><strong>Public Key:</strong> <span class="key-display">${parsed.public_key}</span></div>

                                </div>

                            </div>

                        `;

                    } catch (e) {

                        return `

                            <div class="message-item">

                                <div class="anonymous-badge">ANONYMOUS</div>

                                <div class="message-content">${escapeHtml(msg.content)}</div>

                                <div class="message-meta">

                                    <div><strong>Date:</strong> ${msg.date || 'Unknown'}</div>

                                </div>

                            </div>

                        `;

                    }

                }).join('');

            } catch (error) {

                console.error('Failed to load messages:', error);

            }

        }



        function escapeHtml(text) {

            const div = document.createElement('div');

            div.textContent = text;

            return div.innerHTML;

        }



        function showAlert(message, type) {

            const alertsDiv = document.getElementById('alerts');

            const alertClass = type === 'success' ? 'alert-success' : 

                             type === 'error' ? 'alert-error' : 'alert-warning';

            

            const alert = document.createElement('div');

            alert.className = `alert ${alertClass}`;

            alert.textContent = message;

            

            alertsDiv.appendChild(alert);

            

            setTimeout(() => {

                alert.style.opacity = '0';

                alert.style.transition = 'opacity 0.5s';

                setTimeout(() => alert.remove(), 500);

            }, 5000);

        }



        async function testAPIConnection() {

            try {

                const response = await fetch(`${API_BASE}/api/status`);

                if (response.ok) {

                    document.getElementById('apiStatus').textContent = 'Connected';

                    return true;

                } else {

                    document.getElementById('apiStatus').textContent = 'Error';

                    return false;

                }

            } catch (error) {

                document.getElementById('apiStatus').textContent = 'Offline';

                showAlert('API offline - start P2P node on localhost:5001', 'error');

                return false;

            }

        }



        async function init() {

            // Generate deterministic site keys first

            await initializeSiteKeys();

            

            const apiOk = await testAPIConnection();

            if (!apiOk) return;

            

            await ensureSiteExists();

            

            const keysLoaded = loadKeys();

            if (!keysLoaded) {

                console.log('No stored keys found');

            }

            

            loadMessages();

            setInterval(loadMessages, 10000);

        }



        document.getElementById('messageForm').addEventListener('submit', async (e) => {

            e.preventDefault();

            const message = document.getElementById('messageContent').value.trim();

            if (message && individualPrivateKey) {

                await sendEncryptedMessage(message);

            }

        });



        init();

    </script>

</body>

</html>


